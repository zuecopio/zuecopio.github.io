{"version":3,"names":["signal","createProxy","getProxyFromObject","getNamespaceFromProxy","shouldProxy","PropSignal","setNamespace","resetNamespace","wellKnownSymbols","Set","Object","getOwnPropertyNames","Symbol","map","key","filter","value","proxyToProps","WeakMap","getPropSignal","proxy","initial","has","set","Map","props","get","ns","prop","setGetter","setValue","proxifyState","objToIterable","peeking","stateHandlers","target","receiver","hasOwnProperty","Reflect","desc","getOwnPropertyDescriptor","result","getComputed","args","call","defineProperty","isNew","Array","isArray","length","deleteProperty","undefined","ownKeys","_","namespace","obj","peek"],"sources":["@wordpress/interactivity/src/proxies/state.ts"],"sourcesContent":["/**\n * External dependencies\n */\nimport { signal, type Signal } from '@preact/signals';\n\n/**\n * Internal dependencies\n */\nimport {\n\tcreateProxy,\n\tgetProxyFromObject,\n\tgetNamespaceFromProxy,\n\tshouldProxy,\n} from './registry';\nimport { PropSignal } from './signals';\nimport { setNamespace, resetNamespace } from '../namespaces';\n\n/**\n * Set of built-in symbols.\n */\nconst wellKnownSymbols = new Set(\n\tObject.getOwnPropertyNames( Symbol )\n\t\t.map( ( key ) => Symbol[ key ] )\n\t\t.filter( ( value ) => typeof value === 'symbol' )\n);\n\n/**\n * Relates each proxy with a map of {@link PropSignal} instances, representing\n * the proxy's accessed properties.\n */\nconst proxyToProps: WeakMap<\n\tobject,\n\tMap< string | symbol, PropSignal >\n> = new WeakMap();\n\n/**\n * Returns the {@link PropSignal | `PropSignal`} instance associated with the\n * specified prop in the passed proxy.\n *\n * The `PropSignal` instance is generated if it doesn't exist yet, using the\n * `initial` parameter to initialize the internal signals.\n *\n * @param proxy   Proxy of a state object or array.\n * @param key     The property key.\n * @param initial Initial data for the `PropSignal` instance.\n * @return The `PropSignal` instance.\n */\nconst getPropSignal = (\n\tproxy: object,\n\tkey: string | number | symbol,\n\tinitial?: PropertyDescriptor\n) => {\n\tif ( ! proxyToProps.has( proxy ) ) {\n\t\tproxyToProps.set( proxy, new Map() );\n\t}\n\tkey = typeof key === 'number' ? `${ key }` : key;\n\tconst props = proxyToProps.get( proxy )!;\n\tif ( ! props.has( key ) ) {\n\t\tconst ns = getNamespaceFromProxy( proxy );\n\t\tconst prop = new PropSignal( proxy );\n\t\tprops.set( key, prop );\n\t\tif ( initial ) {\n\t\t\tconst { get, value } = initial;\n\t\t\tif ( get ) {\n\t\t\t\tprop.setGetter( get );\n\t\t\t} else {\n\t\t\t\tprop.setValue(\n\t\t\t\t\tshouldProxy( value ) ? proxifyState( ns, value ) : value\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\treturn props.get( key )!;\n};\n\n/**\n * Relates each proxied object (i.e., the original object) with a signal that\n * tracks changes in the number of properties.\n */\nconst objToIterable = new WeakMap< object, Signal< number > >();\n\n/**\n * When this flag is `true`, it avoids any signal subscription, overriding state\n * props' \"reactive\" behavior.\n */\nlet peeking = false;\n\n/**\n * Handlers for reactive objects and arrays in the state.\n */\nconst stateHandlers: ProxyHandler< object > = {\n\tget( target: object, key: string | symbol, receiver: object ): any {\n\t\t/*\n\t\t * The property should not be reactive for the following cases:\n\t\t * 1. While using the `peek` function to read the property.\n\t\t * 2. The property exists but comes from the Object or Array prototypes.\n\t\t * 3. The property key is a known symbol.\n\t\t */\n\t\tif (\n\t\t\tpeeking ||\n\t\t\t( ! target.hasOwnProperty( key ) && key in target ) ||\n\t\t\t( typeof key === 'symbol' && wellKnownSymbols.has( key ) )\n\t\t) {\n\t\t\treturn Reflect.get( target, key, receiver );\n\t\t}\n\n\t\t// At this point, the property should be reactive.\n\t\tconst desc = Object.getOwnPropertyDescriptor( target, key );\n\t\tconst prop = getPropSignal( receiver, key, desc );\n\t\tconst result = prop.getComputed().value;\n\n\t\t/*\n\t\t * Check if the property is a synchronous function. If it is, set the\n\t\t * default namespace. Synchronous functions always run in the proper scope,\n\t\t * which is set by the Directives component.\n\t\t */\n\t\tif ( typeof result === 'function' ) {\n\t\t\tconst ns = getNamespaceFromProxy( receiver );\n\t\t\treturn ( ...args: unknown[] ) => {\n\t\t\t\tsetNamespace( ns );\n\t\t\t\ttry {\n\t\t\t\t\treturn result.call( receiver, ...args );\n\t\t\t\t} finally {\n\t\t\t\t\tresetNamespace();\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tset(\n\t\ttarget: object,\n\t\tkey: string,\n\t\tvalue: unknown,\n\t\treceiver: object\n\t): boolean {\n\t\tsetNamespace( getNamespaceFromProxy( receiver ) );\n\t\ttry {\n\t\t\treturn Reflect.set( target, key, value, receiver );\n\t\t} finally {\n\t\t\tresetNamespace();\n\t\t}\n\t},\n\n\tdefineProperty(\n\t\ttarget: object,\n\t\tkey: string,\n\t\tdesc: PropertyDescriptor\n\t): boolean {\n\t\tconst isNew = ! ( key in target );\n\t\tconst result = Reflect.defineProperty( target, key, desc );\n\n\t\tif ( result ) {\n\t\t\tconst receiver = getProxyFromObject( target );\n\t\t\tconst prop = getPropSignal( receiver, key );\n\t\t\tconst { get, value } = desc;\n\t\t\tif ( get ) {\n\t\t\t\tprop.setGetter( get );\n\t\t\t} else {\n\t\t\t\tconst ns = getNamespaceFromProxy( receiver );\n\t\t\t\tprop.setValue(\n\t\t\t\t\tshouldProxy( value ) ? proxifyState( ns, value ) : value\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif ( isNew && objToIterable.has( target ) ) {\n\t\t\t\tobjToIterable.get( target )!.value++;\n\t\t\t}\n\n\t\t\t/*\n\t\t\t * Modify the `length` property value only if the related\n\t\t\t * `PropSignal` exists, which means that there are subscriptions to\n\t\t\t * this property.\n\t\t\t */\n\t\t\tif (\n\t\t\t\tArray.isArray( target ) &&\n\t\t\t\tproxyToProps.get( receiver )?.has( 'length' )\n\t\t\t) {\n\t\t\t\tconst length = getPropSignal( receiver, 'length' );\n\t\t\t\tlength.setValue( target.length );\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t},\n\n\tdeleteProperty( target: object, key: string ): boolean {\n\t\tconst result = Reflect.deleteProperty( target, key );\n\n\t\tif ( result ) {\n\t\t\tconst prop = getPropSignal( getProxyFromObject( target ), key );\n\t\t\tprop.setValue( undefined );\n\n\t\t\tif ( objToIterable.has( target ) ) {\n\t\t\t\tobjToIterable.get( target )!.value++;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t},\n\n\townKeys( target: object ): ( string | symbol )[] {\n\t\tif ( ! objToIterable.has( target ) ) {\n\t\t\tobjToIterable.set( target, signal( 0 ) );\n\t\t}\n\t\t/*\n\t\t *This subscribes to the signal while preventing the minifier from\n\t\t * deleting this line in production.\n\t\t */\n\t\t( objToIterable as any )._ = objToIterable.get( target )!.value;\n\t\treturn Reflect.ownKeys( target );\n\t},\n};\n\n/**\n * Returns the proxy associated with the given state object, creating it if it\n * does not exist.\n *\n * @param namespace The namespace that will be associated to this proxy.\n * @param obj       The object to proxify.\n *\n * @throws Error if the object cannot be proxified. Use {@link shouldProxy} to\n *         check if a proxy can be created for a specific object.\n *\n * @return The associated proxy.\n */\nexport const proxifyState = < T extends object >(\n\tnamespace: string,\n\tobj: T\n): T => createProxy( namespace, obj, stateHandlers ) as T;\n\n/**\n * Reads the value of the specified property without subscribing to it.\n *\n * @param obj The object to read the property from.\n * @param key The property key.\n * @return The property value.\n */\nexport const peek = < T extends object, K extends keyof T >(\n\tobj: T,\n\tkey: K\n): T[ K ] => {\n\tpeeking = true;\n\ttry {\n\t\treturn obj[ key ];\n\t} finally {\n\t\tpeeking = false;\n\t}\n};\n"],"mappings":"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","ignoreList":[]}